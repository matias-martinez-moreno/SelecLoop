<!-- ===== TEMPLATE: DETALLE DE EMPRESA ===== -->
<!-- Muestra informaci칩n completa de una empresa y sus rese침as -->
<!-- Control de acceso seg칰n rol y estado de rese침as del usuario -->
<!-- core/templates/core/company_detail.html -->
{% extends 'core/base.html' %}

{% block title %}{{ company.name }} - Rese침as y Opiniones | SelecLoop{% endblock %}

{% block meta_description %}Lee rese침as y opiniones sobre {{ company.name }} en {{ company.location }}{% if company.region %}, {{ company.region }}{% endif %}. Informaci칩n sobre procesos de selecci칩n, entrevistas y cultura laboral.{% endblock %}

{% block meta_keywords %}rese침as {{ company.name }}, opiniones {{ company.name }}, proceso selecci칩n {{ company.name }}, entrevistas {{ company.name }}, trabajo {{ company.location }}{% endblock %}

{% block og_type %}article{% endblock %}

{% block og_title %}{{ company.name }} - Rese침as de Empresa{% endblock %}

{% block og_description %}Descubre rese침as reales sobre {{ company.name }}. Informaci칩n sobre procesos de selecci칩n, entrevistas y experiencias de candidatos.{% endblock %}

{% block geo_meta %}
<meta name="geo.region" content="CO">
<meta name="geo.placename" content="{{ company.location }}">
<meta name="DC.coverage" content="{{ company.location }}, {{ company.country }}">
{% endblock %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "{{ company.name }}",
  "alternateName": "{{ company.name }} Company",
  "description": "{{ company.description|default:'Empresa evaluada por candidatos en procesos de selecci칩n laboral' }}",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "{{ company.location }}",
    "addressLocality": "{{ company.location }}",
    {% if company.region %}"addressRegion": "{{ company.region }}",{% endif %}
    "addressCountry": "{{ company.country }}"
  },
  {% if company.website %}"url": "{{ company.website }}",{% endif %}
  "industry": "{{ company.sector|default:'Technology' }}",
  "employeeCount": "Unknown",
  "foundingDate": "Unknown",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ company_stats.avg_overall|default:0 }}",
    "reviewCount": "{{ company_stats.total_reviews|default:0 }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  "review": [
    {% for review in all_visible_reviews %}
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "{{ review.user_profile.user.get_full_name|default:review.user_profile.user.username }}",
        "jobTitle": "{{ review.job_title }}"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ review.overall_rating }}",
        "bestRating": "5",
        "worstRating": "1"
      },
      "reviewBody": "{{ review.pros|truncatewords:50 }} {{ review.cons|truncatewords:50 }}",
      "datePublished": "{{ review.submission_date|date:'Y-m-d' }}",
      "workPerformed": "{{ review.job_title }}",
      "employmentType": "{{ review.modality|title }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Job Positions",
    "itemListElement": [
      {% for review in all_visible_reviews|slice:":5" %}
      {
        "@type": "Offer",
        "itemOffered": {
          "@type": "JobPosting",
          "title": "{{ review.job_title }}",
          "employmentType": "{{ review.modality|title }}",
          "workHours": "Full-time",
          "location": {
            "@type": "Place",
            "address": {
              "@type": "PostalAddress",
              "addressLocality": "{{ company.location }}",
              "addressCountry": "{{ company.country }}"
            }
          }
        }
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
}
</script>

{% load common_tags %}

{% block content %}
<!-- ===== CONTENIDO PRINCIPAL ===== -->
<div class="container mt-2">
    <!-- ===== INFORMACI칍N DE LA EMPRESA ===== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            {{ company.name }}
                        </h4>
                        <div class="d-flex gap-2">
                            {% if user.profile.role == 'company_rep' and user.profile.company and user.profile.company.id == company.id %}
                                <a href="{% url 'edit_company' company.id %}" class="btn btn-sm" style="background: var(--secondary-blue); color: white; border: 1px solid var(--secondary-blue);" onmouseover="this.style.background='var(--primary-blue)'" onmouseout="this.style.background='var(--secondary-blue)'">
                                    <i class="fas fa-edit me-1"></i>Editar Datos
                                </a>
                            {% elif user.is_staff or user.profile.role == 'staff' %}
                                <a href="{% url 'edit_company' company.id %}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit me-1"></i>Editar
                                </a>
                                <a href="{% url 'toggle_company_status' company.id %}" class="btn btn-sm {% if company.is_active %}btn-secondary{% else %}btn-success{% endif %}" onclick="return confirm('쮼st치s seguro de {% if company.is_active %}desactivar{% else %}activar{% endif %} esta empresa?');">
                                    <i class="fas fa-{% if company.is_active %}pause{% else %}play{% endif %} me-1"></i>
                                    {% if company.is_active %}Desactivar{% else %}Activar{% endif %}
                                </a>
                                <a href="{% url 'delete_company' company.id %}" class="btn btn-sm btn-danger" onclick="return confirm('쮼st치s seguro de borrar esta empresa? Esta acci칩n no se puede deshacer.');">
                                    <i class="fas fa-trash me-1"></i>Borrar
                                </a>
                            {% else %}
                                <span class="text-muted small">Rol: {{ user.profile.role }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            {% if company.logo %}
                                <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="img-fluid rounded" style="max-height: 120px;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <i class="fas fa-building fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Sector:</strong> {{ company.sector }}</p>
                                    <p class="mb-2"><strong>Ciudad:</strong> {{ company.location }}</p>
                                    {% if company.region %}<p class="mb-2"><strong>Regi칩n:</strong> {{ company.region }}</p>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Pa칤s:</strong> {{ company.country }}</p>
                                    <p class="mb-2"><strong>Website:</strong> 
                                        {% if company.website %}
                                            <a href="{{ company.website }}" target="_blank" class="text-primary">{{ company.website }}</a>
                                        {% else %}
                                            No disponible
                                        {% endif %}
                                    </p>
                                    <p class="mb-2"><strong>Estado:</strong> 
                                        <span class="badge {% if company.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if company.is_active %}Activa{% else %}Inactiva{% endif %}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <p class="mb-0"><strong>Descripci칩n:</strong> {{ company.description|default:"No disponible" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ESTILOS PARA ESTAD칈STICAS MEJORADAS ===== -->
    <style>
        .stat-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        .stat-card .stat-icon {
            font-size: 1.8rem;
            opacity: 0.9;
            margin-bottom: 0.4rem;
        }
        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.4rem;
        }
        .stat-card .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.2rem;
        }
        .stat-card .stat-sublabel {
            font-size: 0.65rem;
            color: #6c757d;
            opacity: 0.8;
        }
        /* Unified color scheme - harmonious palette */
        .stat-card-primary,
        .stat-card-success,
        .stat-card-info,
        .stat-card-warning,
        .stat-card-danger,
        .stat-card-secondary {
            background: #ffffff;
            border: 2px solid;
            color: #1a1a1a !important;
        }
        
        /* Color palette - harmonious blues and teals */
        .stat-card-primary {
            border-color: #2563eb; /* Blue 600 */
        }
        .stat-card-success {
            border-color: #0ea5e9; /* Sky 500 */
        }
        .stat-card-info {
            border-color: #06b6d4; /* Cyan 500 */
        }
        .stat-card-warning {
            border-color: #14b8a6; /* Teal 500 */
        }
        .stat-card-danger {
            border-color: #0891b2; /* Cyan 600 */
        }
        .stat-card-secondary {
            border-color: #0284c7; /* Sky 600 */
        }
        
        /* Matching text and icon colors */
        .stat-card-primary .stat-value,
        .stat-card-primary .stat-icon {
            color: #2563eb !important;
        }
        .stat-card-success .stat-value,
        .stat-card-success .stat-icon {
            color: #0ea5e9 !important;
        }
        .stat-card-info .stat-value,
        .stat-card-info .stat-icon {
            color: #06b6d4 !important;
        }
        .stat-card-warning .stat-value,
        .stat-card-warning .stat-icon {
            color: #14b8a6 !important;
        }
        .stat-card-danger .stat-value,
        .stat-card-danger .stat-icon {
            color: #0891b2 !important;
        }
        .stat-card-secondary .stat-value,
        .stat-card-secondary .stat-icon {
            color: #0284c7 !important;
        }
        
        .stat-card-primary .stat-label,
        .stat-card-success .stat-label,
        .stat-card-info .stat-label,
        .stat-card-warning .stat-label,
        .stat-card-danger .stat-label,
        .stat-card-secondary .stat-label {
            color: #374151 !important;
        }
        .stat-card-primary .stat-sublabel,
        .stat-card-success .stat-sublabel,
        .stat-card-info .stat-sublabel,
        .stat-card-warning .stat-sublabel,
        .stat-card-danger .stat-sublabel,
        .stat-card-secondary .stat-sublabel {
            color: #6b7280 !important;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        .chart-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }
        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
    </style>

    <!-- ===== ESTAD칈STICAS DE LA EMPRESA ===== -->
    {% if user_can_access and company_stats and company_stats.total_reviews > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                {% if user.profile.role == 'candidate' %}
                <div class="card-header bg-primary text-white" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);">
                    <h3 class="h5 mb-0"><i class="fas fa-chart-line me-2"></i>Estad칤sticas de la Empresa</h3>
                </div>
                {% endif %}
                <div class="card-body p-4">
                    {% if user.profile.role == 'candidate' %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-user-graduate me-2"></i>
                                Informaci칩n para Candidatos
                            </h5>
                            <p class="text-muted small">Datos que te ayudan a decidir si aplicar a esta empresa</p>
                        </div>
                    </div>

                    <!-- M칠tricas Principales en Grid -->
                    <div class="row g-3 mb-4">
                        <!-- Calificaci칩n General -->
                        <div class="col-md-3 col-sm-6">
                            <div class="card h-100 border-primary border-2">
                                <div class="card-body text-center p-3">
                                    <div class="display-3 mb-2 text-primary fw-bold">{{ role_kpis.avg_overall|floatformat:1 }}</div>
                                    <div class="small text-muted mb-1">Calificaci칩n General</div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: {% widthratio role_kpis.avg_overall 5 100 %}%" aria-valuenow="{% widthratio role_kpis.avg_overall 5 100 %}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">de 5.0</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Rese침as -->
                        <div class="col-md-3 col-sm-6">
                            <div class="card h-100 border-info border-2">
                                <div class="card-body text-center p-3">
                                    <div class="display-3 mb-2 text-info fw-bold">{{ role_kpis.total_reviews }}</div>
                                    <div class="small text-muted mb-1">Total Rese침as</div>
                                    <div class="d-flex justify-content-center gap-2 small">
                                        <span class="badge bg-success">{{ role_kpis.total_reviews }} aprobadas</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tasa de Aprobaci칩n (siempre 100% para candidatos ya que solo ven aprobadas) -->
                        <div class="col-md-3 col-sm-6">
                            <div class="card h-100 border-success border-2">
                                <div class="card-body text-center p-3">
                                    <div class="display-3 mb-2 text-success fw-bold">100%</div>
                                    <div class="small text-muted mb-1">Tasa de Aprobaci칩n</div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ role_kpis.total_reviews }} de {{ role_kpis.total_reviews }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Respuestas R치pidas -->
                        <div class="col-md-3 col-sm-6">
                            <div class="card h-100 border-warning border-2">
                                <div class="card-body text-center p-3">
                                    <div class="display-3 mb-2 text-warning fw-bold">{{ role_kpis.fast_response_rate|floatformat:0 }}%</div>
                                    <div class="small text-muted mb-1">Respuestas R치pidas</div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ role_kpis.fast_response_rate|floatformat:0 }}%" aria-valuenow="{{ role_kpis.fast_response_rate|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- M칠tricas de Calidad del Proceso -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-star me-2"></i>
                                Calidad del Proceso de Selecci칩n
                            </h6>
                        </div>
                        
                        <!-- Comunicaci칩n -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <i class="fas fa-comments text-primary me-2"></i>
                                            <strong>Comunicaci칩n</strong>
                                        </div>
                                        <div class="h4 mb-0 text-primary">{{ role_kpis.avg_communication|floatformat:1 }}/5</div>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: {% widthratio role_kpis.avg_communication 5 100 %}%" aria-valuenow="{% widthratio role_kpis.avg_communication 5 100 %}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">Claridad en respuestas a candidatos</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dificultad -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <i class="fas fa-tasks text-warning me-2"></i>
                                            <strong>Dificultad</strong>
                                        </div>
                                        <div class="h4 mb-0 text-warning">{{ role_kpis.avg_difficulty|floatformat:1 }}/5</div>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: {% widthratio role_kpis.avg_difficulty 5 100 %}%" aria-valuenow="{% widthratio role_kpis.avg_difficulty 5 100 %}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">Complejidad del proceso</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Velocidad -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <i class="fas fa-clock text-info me-2"></i>
                                            <strong>Velocidad</strong>
                                        </div>
                                        <div class="h4 mb-0 text-info">{{ role_kpis.avg_response_time|floatformat:1 }}/5</div>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {% widthratio role_kpis.avg_response_time 5 100 %}%" aria-valuenow="{% widthratio role_kpis.avg_response_time 5 100 %}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">Tiempo de respuesta</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci칩n adicional -->
                    <div class="alert alert-info" id="useful-info-alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>游눠 Informaci칩n 칰til:</strong>
                        <span id="useful-info-text">
                            Basado en {{ role_kpis.total_reviews }} rese침as de candidatos.
                            {% if role_kpis.top_modality_rating %}
                            El trabajo {{ role_kpis.top_modality|lower }} tiene {{ role_kpis.top_modality_rating }}/5 estrellas de promedio.
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if role_kpis.modalities_data %}
                    {{ role_kpis.modalities_data|json_script:"modalities-data" }}
                    <script>
                        // Datos de modalidades para rotaci칩n
                        const modalitiesDataElement = document.getElementById('modalities-data');
                        const modalitiesData = modalitiesDataElement ? JSON.parse(modalitiesDataElement.textContent) : [];
                        const totalReviews = {{ role_kpis.total_reviews|default:0 }};
                        
                        // Funci칩n para obtener modalidad rotando cada vez que se carga la p치gina
                        // Usa el timestamp actual para cambiar cada vez que se recarga
                        function getRotatingModality() {
                            if (modalitiesData.length === 0) return null;
                            // Usar milisegundos para que cambie m치s frecuentemente
                            const index = Math.floor((Date.now() / 100) % modalitiesData.length);
                            return modalitiesData[index];
                        }
                        
                        // Actualizar el mensaje de informaci칩n 칰til
                        document.addEventListener('DOMContentLoaded', function() {
                            const usefulInfoText = document.getElementById('useful-info-text');
                            if (usefulInfoText && modalitiesData && modalitiesData.length > 0) {
                                const selectedModality = getRotatingModality();
                                if (selectedModality) {
                                    const modalityNames = {
                                        'presencial': 'presencial',
                                        'remoto': 'online',
                                        'online': 'online',
                                        'hibrido': 'h칤brido',
                                        'hybrid': 'h칤brido',
                                        'h칤brido': 'h칤brido'
                                    };
                                    const modalityName = modalityNames[selectedModality.modality.toLowerCase()] || selectedModality.modality.toLowerCase();
                                    usefulInfoText.innerHTML = `Basado en ${totalReviews} rese침as de candidatos. El trabajo ${modalityName} tiene ${selectedModality.avg_rating}/5 estrellas de promedio.`;
                                }
                            }
                        });
                    </script>
                    {% endif %}
    
                    {% elif user.profile.role == 'company_rep' %}
                    <!-- Para company_rep, mostrar mensaje para ir al dashboard -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Para ver el Panel de Control completo de tu empresa, ve al Dashboard.</strong>
                                    </div>
                                    <a href="{% url 'company_dashboard' %}" class="btn btn-primary">
                                        <i class="fas fa-chart-line me-2"></i>Ir al Panel de Control
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===== GR츼FICOS DE AN츼LISIS (SOLO PARA USUARIOS SIN RESE칌AS PENDIENTES) ===== -->
    {% if user_can_access and chart_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        An치lisis Visual de Datos
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card chart-card shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-star text-warning me-2"></i>
                                        Distribuci칩n de Calificaciones
                                    </h6>
                                    {% if chart_data.ratings %}
                                    <div class="chart-container">
                                        <canvas id="ratingsChart"></canvas>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                        <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card chart-card shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-briefcase text-primary me-2"></i>
                                        Modalidad de Trabajo
                                    </h6>
                                    {% if chart_data.modality %}
                                    <div class="chart-container">
                                        <canvas id="modalityChart"></canvas>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                                        <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card chart-card shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-radar text-success me-2"></i>
                                        Fortalezas y Debilidades
                                    </h6>
                                    {% if chart_data.strengths_weaknesses %}
                                    <div class="chart-container">
                                        <canvas id="strengthsWeaknessesChart"></canvas>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-radar fa-3x text-muted mb-3"></i>
                                        <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card chart-card shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-clock text-info me-2"></i>
                                        Distribuci칩n de Tiempo de Respuesta
                                    </h6>
                                    {% if chart_data.response_time_distribution %}
                                    <div class="chart-container">
                                        <canvas id="responseTimeChart"></canvas>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                                        <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if user.profile.role == 'company_rep' and role_kpis.monthly_trend %}
                        <div class="col-md-12 mb-4">
                            <div class="card chart-card shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-chart-bar text-primary me-2"></i>
                                        Comparaci칩n Mes a Mes - Evoluci칩n de Calificaciones
                                    </h6>
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="monthlyComparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contenido condicional seg칰n acceso -->
    {% if user.is_staff or user.profile.role == 'staff' or user_can_access and user.profile.role != 'company_rep' %}
        <!-- Usuario puede acceder - mostrar rese침as (candidatos y staff, no para company_rep) -->
        <div id="reviews-section" class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h3 text-primary mb-0">Rese침as de la Empresa</h2>
                    {% if total_approved_reviews_count > 0 %}
                    <span class="badge bg-primary">
                        <i class="fas fa-comments me-1"></i>
                        {% if has_active_filters %}
                            {{ approved_reviews|length }} de {{ total_approved_reviews_count }} rese침a{{ total_approved_reviews_count|pluralize }}
                        {% else %}
                            {{ total_approved_reviews_count }} rese침a{{ total_approved_reviews_count|pluralize }}
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
                
                {% if user_can_create_review and user.profile.role == 'candidate' %}
                <div class="row mb-4">
                    <div class="col-12">
                        <a href="{% url 'create_review' %}?company={{ company.id }}" class="btn btn-lg w-100" style="background: var(--secondary-blue); color: white; border: 1px solid var(--secondary-blue);" onmouseover="this.style.background='var(--primary-blue)'" onmouseout="this.style.background='var(--secondary-blue)'">
                            <i class="fas fa-plus me-2"></i>Crear Rese침a
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Filtros de rese침as - Siempre mostrar si hay rese침as aprobadas en total -->
                {% if total_approved_reviews_count > 0 %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form method="get" action="{% url 'company_detail' company.id %}#reviews-section" class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="rating" class="form-label small fw-bold">
                                    <i class="fas fa-star text-warning me-1"></i>Calificaci칩n
                                </label>
                                <select name="rating" id="rating" class="form-select form-select-sm">
                                    <option value="">Todas las calificaciones</option>
                                    <option value="5" {% if current_filters.rating == '5' %}selected{% endif %}>5 estrellas</option>
                                    <option value="4" {% if current_filters.rating == '4' %}selected{% endif %}>4 estrellas</option>
                                    <option value="3" {% if current_filters.rating == '3' %}selected{% endif %}>3 estrellas</option>
                                    <option value="2" {% if current_filters.rating == '2' %}selected{% endif %}>2 estrellas</option>
                                    <option value="1" {% if current_filters.rating == '1' %}selected{% endif %}>1 estrella</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="modality" class="form-label small fw-bold">
                                    <i class="fas fa-briefcase text-primary me-1"></i>Modalidad
                                </label>
                                <select name="modality" id="modality" class="form-select form-select-sm">
                                    <option value="">Todas las modalidades</option>
                                    <option value="presencial" {% if current_filters.modality == 'presencial' %}selected{% endif %}>Presencial</option>
                                    <option value="remoto" {% if current_filters.modality == 'remoto' %}selected{% endif %}>Remoto</option>
                                    <option value="hibrido" {% if current_filters.modality == 'hibrido' %}selected{% endif %}>H칤brido</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="sort" class="form-label small fw-bold">
                                    <i class="fas fa-sort text-info me-1"></i>Ordenar por
                                </label>
                                <select name="sort" id="sort" class="form-select form-select-sm">
                                    <option value="recent" {% if current_filters.sort == 'recent' or not current_filters.sort %}selected{% endif %}>M치s recientes</option>
                                    <option value="oldest" {% if current_filters.sort == 'oldest' %}selected{% endif %}>M치s antiguas</option>
                                    <option value="highest" {% if current_filters.sort == 'highest' %}selected{% endif %}>Mejor calificadas</option>
                                    <option value="lowest" {% if current_filters.sort == 'lowest' %}selected{% endif %}>Peor calificadas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-filter me-1"></i>Filtrar
                                </button>
                                {% if current_filters.rating or current_filters.modality or current_filters.sort %}
                                <a href="{% url 'company_detail' company.id %}#reviews-section" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                                    <i class="fas fa-times me-1"></i>Limpiar
                                </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
                
                <!-- Mostrar rese침as si hay resultados -->
                {% if approved_reviews|length > 0 %}
                    <div class="row">
                        {% for review in approved_reviews %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                                        <h6 class="mb-0 text-truncate text-white" style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ review.user_profile.user.get_full_name|default:review.user_profile.user.username }}">
                                            <i class="fas fa-user me-1"></i>
                                            {{ review.user_profile.user.get_full_name|default:review.user_profile.user.username }}
                                        </h6>
                                        {% if user.is_authenticated %}
                                        <a href="{% url 'view_user_profile' review.user_profile.user.id %}" 
                                           class="btn btn-xs flex-shrink-0" 
                                           title="Ver perfil del usuario"
                                           style="background-color: #6c757d; border-color: #6c757d; color: #ffffff; font-size: 0.7rem; padding: 0.2em 0.7em;">
                                            <i class="fas fa-user me-1"></i>Ver Perfil
                                        </a>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-success flex-shrink-0">
                                            <i class="fas fa-check me-1"></i>Aprobada
                                        </span>
                                        {% if user.is_staff or user.profile.role == 'staff' %}
                                        <a href="{% url 'delete_review' review.id %}" class="btn btn-sm btn-danger" onclick="return confirm('쮼st치s seguro de borrar esta rese침a? Esta acci칩n no se puede deshacer.');" title="Borrar rese침a">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text small text-muted mb-1">
                                        <i class="fas fa-briefcase me-1"></i>
                                        <strong>Cargo:</strong> {{ review.job_title }}
                                    </p>
                                    <p class="card-text small text-muted mb-1">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        <strong>Modalidad:</strong> {{ review.get_modality_display }}
                                    </p>
                                    {% if review.image %}
                                    <div class="mb-3">
                                        <img src="{{ review.image.url }}" alt="Imagen rese침a" class="img-fluid rounded" style="max-height: 160px; object-fit: cover;">
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        <strong class="text-success small">Pros:</strong>
                                        <p class="mb-2 small">{{ review.pros }}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong class="text-danger small">Contras:</strong>
                                        <p class="mb-2 small">{{ review.cons }}</p>
                                    </div>

                                    {% if review.interview_questions %}
                                    <div class="mb-3">
                                        <strong class="small">Preguntas de la Entrevista:</strong>
                                        <p class="mb-2 small">{{ review.interview_questions }}</p>
                                    </div>
                                    {% endif %}

                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ review.submission_date|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                                <div class="card-footer">
                                    <span class="badge bg-primary">Calificaci칩n: {{ review.overall_rating }}/5</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% elif has_active_filters %}
                    <!-- Mensaje cuando hay filtros activos pero no hay resultados -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>No se encontraron rese침as</strong> que coincidan con los filtros aplicados.
                        <a href="{% url 'company_detail' company.id %}#reviews-section" class="alert-link ms-2">
                            <i class="fas fa-times me-1"></i>Limpiar filtros
                        </a>
                        para ver todas las {{ total_approved_reviews_count }} rese침a{{ total_approved_reviews_count|pluralize }} disponibles.
                    </div>
                {% elif total_approved_reviews_count == 0 %}
                    <!-- Solo mostrar este mensaje si realmente NO hay rese침as aprobadas en total (sin filtrar) -->
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No hay rese침as a칰n</h4>
                        <p class="text-muted">S칠 el primero en compartir tu experiencia con esta empresa.</p>
                        {% if user_can_create_review and user.profile.role == 'candidate' %}
                            <a href="{% url 'create_review' %}?company={{ company.id }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Crear Primera Rese침a
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    {% elif user.profile.role == 'company_rep' %}
        <!-- Para company_rep, redirigir a la vista de rese침as -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Las rese침as de tu empresa est치n disponibles en una secci칩n dedicada.</strong>
                        </div>
                        <a href="{% url 'company_reviews' %}" class="btn btn-primary">
                            <i class="fas fa-comments me-2"></i>Ver Rese침as de la Empresa
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% elif not user.is_staff and user.profile.role != 'staff' %}
        <!-- Usuario no puede acceder - mostrar mensaje apropiado (solo para candidatos, no para staff) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="h5 mb-0">
                            {% if user_has_pending_review %}
                                <i class="fas fa-clock me-2"></i>Rese침a Pendiente
                            {% elif user_has_contributed %}
                                <i class="fas fa-clock me-2"></i>Rese침a en Revisi칩n
                            {% else %}
                                <i class="fas fa-handshake me-2"></i>Participaci칩n Requerida
                            {% endif %}
                        </h3>
                    </div>
                    <div class="card-body text-center py-5">
                        {% if user_has_pending_review %}
                            <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                            <h4 class="text-warning">Tienes rese침as pendientes</h4>
                            <p class="text-muted">Tienes rese침as pendientes que debes completar antes de poder ver el contenido de cualquier empresa.</p>
                            <div class="mt-4">
                                <a href="{% url 'my_reviews' %}" class="btn btn-info">
                                    <i class="fas fa-list me-2"></i>Ver Mis Rese침as
                                </a>
                            </div>
                        {% elif user_has_contributed %}
                            <i class="fas fa-hourglass-half fa-4x text-warning mb-3"></i>
                            <h4 class="text-warning">Tu rese침a est치 siendo revisada</h4>
                            <p class="text-muted">Una vez aprobada, podr치s acceder al contenido completo de esta empresa.</p>
                            <div class="mt-4">
                                <a href="{% url 'my_reviews' %}" class="btn btn-info me-2">
                                    <i class="fas fa-list me-2"></i>Ver Mis Rese침as
                                </a>
                                <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-home me-2"></i>Explorar Otras Empresas
                                </a>
                            </div>
                        {% else %}
                            <i class="fas fa-handshake fa-4x text-warning mb-3"></i>
                            <h4 class="text-warning">Para ver las rese침as de esta empresa, primero debes participar</h4>
                            <p class="text-muted">Comparte tu experiencia en un proceso de selecci칩n para desbloquear el contenido completo.</p>
                            <p class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                El staff te asignar치 una empresa cuando participes en un proceso de selecci칩n.
                            </p>
                            <a href="{% url 'dashboard' %}" class="btn btn-primary btn-lg">
                                <i class="fas fa-building me-2"></i>Explorar Otras Empresas
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Botones de navegaci칩n -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex gap-2">
                {% if user.profile.role == 'company_rep' %}
                    <a href="{% url 'company_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Panel de Empresa
                    </a>
                {% else %}
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ chart_data|json_script:"chart-data" }}
{% if user.profile.role == 'company_rep' and role_kpis.monthly_trend %}
{{ role_kpis.monthly_trend|json_script:"monthly-trend-data" }}
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos de los gr치ficos
    const chartData = JSON.parse(document.getElementById('chart-data').textContent);
    
    // Debug: Mostrar informaci칩n de debug en consola
    if (chartData.debug_info) {
        console.log('=== DEBUG INFO DE GR츼FICAS ===');
        console.log('Total rese침as:', chartData.debug_info.total_reviews);
        console.log('Fecha 칰ltima rese침a:', chartData.debug_info.latest_review_date);
        console.log('Hora actual:', chartData.debug_info.current_time);
        console.log('Datos de calificaciones:', chartData.debug_info.ratings_data);
        console.log('Datos de modalidad:', chartData.debug_info.modality_data);
        console.log('Datos de estado:', chartData.debug_info.status_data);
        console.log('Datos de timeline:', chartData.debug_info.timeline_data);
        console.log('Datos de fortalezas:', chartData.debug_info.strengths_data);
        console.log('================================');
    }
    
    const colors = {
        primary: '#1E3A8A',
        secondary: '#3B82F6',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        info: '#3B82F6',
    };
    
    // Gr치fico de distribuci칩n de calificaciones
    if (chartData.ratings && Object.keys(chartData.ratings).length > 0) {
        const ratingsCtx = document.getElementById('ratingsChart');
        if (ratingsCtx) {
            const labels = Object.keys(chartData.ratings);
            const data = Object.values(chartData.ratings);
            const maxValue = Math.max(...data);
            const maxIndex = data.indexOf(maxValue);
            
            new Chart(ratingsCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'N칰mero de Rese침as',
                        data: data,
                        backgroundColor: data.map((val, idx) => idx === maxIndex ? colors.warning : colors.primary),
                        borderColor: data.map((val, idx) => idx === maxIndex ? colors.danger : colors.primary),
                        borderWidth: 3,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                                    return `${context.parsed.y} rese침as (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    }
    
    // Gr치fico de modalidad
    if (chartData.modality && Object.keys(chartData.modality).length > 0) {
        const modalityCtx = document.getElementById('modalityChart');
        if (modalityCtx) {
            new Chart(modalityCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(chartData.modality),
                    datasets: [{
                        data: Object.values(chartData.modality),
                        backgroundColor: [colors.primary, colors.success, colors.warning, colors.info, colors.danger],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    }
    
    // Gr치fico de Fortalezas y Debilidades (Radar Chart)
    if (chartData.strengths_weaknesses && Object.keys(chartData.strengths_weaknesses).length > 0) {
        const swCtx = document.getElementById('strengthsWeaknessesChart');
        if (swCtx) {
            const labels = Object.keys(chartData.strengths_weaknesses);
            const data = Object.values(chartData.strengths_weaknesses);
            
            new Chart(swCtx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calificaci칩n Promedio',
                        data: data,
                        backgroundColor: 'rgba(30, 58, 138, 0.3)',
                        borderColor: colors.primary,
                        borderWidth: 3,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: '#ffffff',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: colors.primary,
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5,
                            min: 0,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 },
                                color: '#6b7280'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: { size: 12, weight: 'bold' },
                                color: '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.r.toFixed(1) + ' / 5.0';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Gr치fico de tiempo de respuesta
    if (chartData.response_time_distribution && Object.keys(chartData.response_time_distribution).length > 0) {
        const responseTimeCtx = document.getElementById('responseTimeChart');
        if (responseTimeCtx) {
            const labels = Object.keys(chartData.response_time_distribution);
            const data = Object.values(chartData.response_time_distribution);
            const maxValue = Math.max(...data);
            const maxIndex = data.indexOf(maxValue);
            
            new Chart(responseTimeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'N칰mero de Rese침as',
                        data: data,
                        backgroundColor: data.map((val, idx) => idx === maxIndex ? colors.success : colors.info),
                        borderColor: data.map((val, idx) => idx === maxIndex ? colors.warning : colors.info),
                        borderWidth: 2,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }
    }
    
    // Gr치fico de comparaci칩n mes a mes (solo para company_rep)
    {% if user.profile.role == 'company_rep' and role_kpis.monthly_trend %}
    const monthlyComparisonCtx = document.getElementById('monthlyComparisonChart');
    if (monthlyComparisonCtx) {
        const monthlyTrendElement = document.getElementById('monthly-trend-data');
        let monthlyData = null;
        if (monthlyTrendElement) {
            try {
                monthlyData = JSON.parse(monthlyTrendElement.textContent);
            } catch (e) {
                console.error('Error parsing monthly trend data:', e);
            }
        }
        
        if (monthlyData && monthlyData.length > 0) {
            const months = monthlyData.map(item => {
                const date = new Date(item.month);
                return date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
            });
            const ratings = monthlyData.map(item => parseFloat(item.avg_rating) || 0);
            const counts = monthlyData.map(item => item.count || 0);
            
            new Chart(monthlyComparisonCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Calificaci칩n Promedio',
                            data: ratings,
                            borderColor: colors.primary,
                            backgroundColor: 'rgba(30, 58, 138, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Total Rese침as',
                            data: counts,
                            borderColor: colors.info,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 12, family: "'Segoe UI', sans-serif" },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            padding: 14,
                            titleFont: { size: 14, weight: 'bold', family: "'Segoe UI', sans-serif" },
                            bodyFont: { size: 13, family: "'Segoe UI', sans-serif" },
                            cornerRadius: 10
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Calificaci칩n Promedio',
                                font: { size: 12, weight: 'bold' },
                                color: colors.primary
                            },
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 0.5,
                                font: { size: 11 },
                                color: colors.primary
                            },
                            grid: {
                                color: 'rgba(30, 58, 138, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Cantidad de Rese침as',
                                font: { size: 12, weight: 'bold' },
                                color: colors.info
                            },
                            min: 0,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 },
                                color: colors.info
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 11 },
                                color: '#6b7280'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    }
    {% endif %}
});

// Scroll suave a la secci칩n de rese침as si hay filtros activos o si hay un hash en la URL
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si hay filtros activos o si la URL tiene el hash #reviews-section
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilters = urlParams.get('rating') || urlParams.get('modality') || urlParams.get('sort');
    const hasHash = window.location.hash === '#reviews-section';
    
    if (hasFilters || hasHash) {
        // Esperar un momento para que la p치gina se cargue completamente
        setTimeout(function() {
            const reviewsSection = document.getElementById('reviews-section');
            if (reviewsSection) {
                // Calcular la posici칩n con un offset para el header/navbar
                const offset = 80; // Ajustar seg칰n el tama침o de tu navbar
                const elementPosition = reviewsSection.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        }, 100);
    }
});
</script>

<!-- Modal para exportar Excel -->
{% if user.profile.role == 'company_rep' %}
<div class="modal fade" id="exportExcelModal" tabindex="-1" aria-labelledby="exportExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportExcelModalLabel">
                    <i class="fas fa-file-excel me-2"></i>Exportar Reporte a Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="get" action="{% url 'export_company_report_excel' company.id %}">
                    <div class="mb-3">
                        <label for="exportPeriod" class="form-label">Seleccionar Per칤odo:</label>
                        <select class="form-select" id="exportPeriod" name="period" required>
                            <option value="all">En General (Todas las rese침as)</option>
                            {% if role_kpis.monthly_trend %}
                                {% for month_data in role_kpis.monthly_trend %}
                                <option value="{{ month_data.month|date:'Y-m' }}">
                                    {{ month_data.month|fecha_espanol }} ({{ month_data.count }} rese침a{{ month_data.count|pluralize }})
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportRating" class="form-label">Filtrar por Calificaci칩n:</label>
                        <select class="form-select" id="exportRating" name="rating">
                            <option value="">Todas las calificaciones</option>
                            <option value="5">5 estrellas</option>
                            <option value="4">4 estrellas</option>
                            <option value="3">3 estrellas</option>
                            <option value="2">2 estrellas</option>
                            <option value="1">1 estrella</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Seleccionar Columnas a Incluir:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="colAll" checked onchange="toggleAllColumns(this)">
                            <label class="form-check-label" for="colAll">
                                <strong>Todas las columnas</strong>
                            </label>
                        </div>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="fecha" id="colFecha" checked>
                                    <label class="form-check-label" for="colFecha">Fecha</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="usuario" id="colUsuario" checked>
                                    <label class="form-check-label" for="colUsuario">Usuario</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="cargo" id="colCargo" checked>
                                    <label class="form-check-label" for="colCargo">Cargo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="modalidad" id="colModalidad" checked>
                                    <label class="form-check-label" for="colModalidad">Modalidad</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="calificacion" id="colCalificacion" checked>
                                    <label class="form-check-label" for="colCalificacion">Calificaci칩n</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="comunicacion" id="colComunicacion" checked>
                                    <label class="form-check-label" for="colComunicacion">Comunicaci칩n</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="dificultad" id="colDificultad" checked>
                                    <label class="form-check-label" for="colDificultad">Dificultad</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="tiempo_respuesta" id="colTiempo" checked>
                                    <label class="form-check-label" for="colTiempo">Tiempo Respuesta</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="pros" id="colPros" checked>
                                    <label class="form-check-label" for="colPros">Pros</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="contras" id="colContras" checked>
                                    <label class="form-check-label" for="colContras">Contras</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input column-check" type="checkbox" name="columns" value="preguntas" id="colPreguntas" checked>
                                    <label class="form-check-label" for="colPreguntas">Preguntas Entrevista</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle me-1"></i>
                        Selecciona per칤odo, calificaci칩n y columnas a incluir en el reporte.
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Descargar Excel
                        </button>
                    </div>
                </form>
            </div>
            
            <script>
            function toggleAllColumns(checkbox) {
                const columnChecks = document.querySelectorAll('.column-check');
                columnChecks.forEach(check => {
                    check.checked = checkbox.checked;
                });
            }
            
            // Si se desmarca una columna individual, desmarcar "Todas"
            document.querySelectorAll('.column-check').forEach(check => {
                check.addEventListener('change', function() {
                    const allChecked = Array.from(document.querySelectorAll('.column-check')).every(c => c.checked);
                    document.getElementById('colAll').checked = allChecked;
                });
            });
            </script>
        </div>
    </div>
</div>
{% endif %}

<!-- Datos estructurados adicionales para AEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ company.name }} - Rese침as y Opiniones",
  "description": "Lee rese침as y opiniones sobre {{ company.name }} en {{ company.location }}",
  "url": "{{ request.build_absolute_uri }}",
  "mainEntity": {
    "@type": "Organization",
    "name": "{{ company.name }}",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "{{ company.location }}",
      {% if company.region %}"addressRegion": "{{ company.region }}",{% endif %}
      "addressCountry": "{{ company.country }}"
    }
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "{{ request.scheme }}://{{ request.get_host }}/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Empresas",
        "item": "{{ request.scheme }}://{{ request.get_host }}/dashboard/"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": "{{ company.name }}",
        "item": "{{ request.build_absolute_uri }}"
      }
    ]
  }
}
</script>

{% endblock %}