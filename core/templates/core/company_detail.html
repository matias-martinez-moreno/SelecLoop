<!-- ===== TEMPLATE: DETALLE DE EMPRESA ===== -->
<!-- Muestra informaci칩n completa de una empresa y sus rese침as -->
<!-- Control de acceso seg칰n rol y estado de rese침as del usuario -->
<!-- core/templates/core/company_detail.html -->
{% extends 'core/base.html' %}

{% block title %}{{ company.name }} - Rese침as y Opiniones | SelecLoop{% endblock %}

{% block meta_description %}Lee rese침as y opiniones sobre {{ company.name }} en {{ company.location }}{% if company.region %}, {{ company.region }}{% endif %}. Informaci칩n sobre procesos de selecci칩n, entrevistas y cultura laboral.{% endblock %}

{% block meta_keywords %}rese침as {{ company.name }}, opiniones {{ company.name }}, proceso selecci칩n {{ company.name }}, entrevistas {{ company.name }}, trabajo {{ company.location }}{% endblock %}

{% block og_type %}article{% endblock %}

{% block og_title %}{{ company.name }} - Rese침as de Empresa{% endblock %}

{% block og_description %}Descubre rese침as reales sobre {{ company.name }}. Informaci칩n sobre procesos de selecci칩n, entrevistas y experiencias de candidatos.{% endblock %}

{% block geo_meta %}
<meta name="geo.region" content="CO">
<meta name="geo.placename" content="{{ company.location }}">
<meta name="DC.coverage" content="{{ company.location }}, {{ company.country }}">
{% endblock %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "{{ company.name }}",
  "alternateName": "{{ company.name }} Company",
  "description": "{{ company.description|default:'Empresa evaluada por candidatos en procesos de selecci칩n laboral' }}",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "{{ company.location }}",
    "addressLocality": "{{ company.location }}",
    {% if company.region %}"addressRegion": "{{ company.region }}",{% endif %}
    "addressCountry": "{{ company.country }}"
  },
  {% if company.website %}"url": "{{ company.website }}",{% endif %}
  "industry": "{{ company.sector|default:'Technology' }}",
  "employeeCount": "Unknown",
  "foundingDate": "Unknown",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ company_stats.avg_overall|default:0 }}",
    "reviewCount": "{{ company_stats.total_reviews|default:0 }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  "review": [
    {% for review in all_visible_reviews %}
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "{{ review.user_profile.user.get_full_name|default:review.user_profile.user.username }}",
        "jobTitle": "{{ review.job_title }}"
      },
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ review.overall_rating }}",
        "bestRating": "5",
        "worstRating": "1"
      },
      "reviewBody": "{{ review.pros|truncatewords:50 }} {{ review.cons|truncatewords:50 }}",
      "datePublished": "{{ review.submission_date|date:'Y-m-d' }}",
      "workPerformed": "{{ review.job_title }}",
      "employmentType": "{{ review.modality|title }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Job Positions",
    "itemListElement": [
      {% for review in all_visible_reviews|slice:":5" %}
      {
        "@type": "Offer",
        "itemOffered": {
          "@type": "JobPosting",
          "title": "{{ review.job_title }}",
          "employmentType": "{{ review.modality|title }}",
          "workHours": "Full-time",
          "location": {
            "@type": "Place",
            "address": {
              "@type": "PostalAddress",
              "addressLocality": "{{ company.location }}",
              "addressCountry": "{{ company.country }}"
            }
          }
        }
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
}
</script>

{% block content %}
<!-- ===== CONTENIDO PRINCIPAL ===== -->
<div class="container mt-2">
    <!-- ===== INFORMACI칍N DE LA EMPRESA ===== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            {{ company.name }}
                        </h4>
                        {% if user.profile.role == 'company_rep' %}
                            <a href="{% url 'edit_company' company.id %}" class="btn btn-sm" style="background: var(--secondary-blue); color: white; border: 1px solid var(--secondary-blue);" onmouseover="this.style.background='var(--primary-blue)'" onmouseout="this.style.background='var(--secondary-blue)'">
                                <i class="fas fa-edit me-1"></i>Editar Datos
                            </a>
                        {% else %}
                            <span class="text-muted small">Rol: {{ user.profile.role }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            {% if company.logo %}
                                <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="img-fluid rounded" style="max-height: 120px;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <i class="fas fa-building fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Sector:</strong> {{ company.sector }}</p>
                                    <p class="mb-2"><strong>Ciudad:</strong> {{ company.location }}</p>
                                    {% if company.region %}<p class="mb-2"><strong>Regi칩n:</strong> {{ company.region }}</p>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Pa칤s:</strong> {{ company.country }}</p>
                                    <p class="mb-2"><strong>Website:</strong> 
                                        {% if company.website %}
                                            <a href="{{ company.website }}" target="_blank" class="text-primary">{{ company.website }}</a>
                                        {% else %}
                                            No disponible
                                        {% endif %}
                                    </p>
                                    <p class="mb-2"><strong>Estado:</strong> 
                                        <span class="badge {% if company.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if company.is_active %}Activa{% else %}Inactiva{% endif %}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <p class="mb-0"><strong>Descripci칩n:</strong> {{ company.description|default:"No disponible" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ESTAD칈STICAS DE LA EMPRESA ===== -->
    {% if user_can_access and company_stats and company_stats.total_reviews > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="h5 mb-0"><i class="fas fa-chart-bar me-2"></i>Estad칤sticas de la Empresa</h3>
                </div>
                <div class="card-body">
                    {% if user.profile.role == 'candidate' %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-user-graduate me-2"></i>
                                Informaci칩n para Candidatos
                            </h5>
                            <p class="text-muted small">Datos que te ayudan a decidir si aplicar a esta empresa</p>
                        </div>
                    </div>

                    <!-- 6 tarjetas principales -->
                    <div class="row mb-4 g-3">
                        <!-- Calificaci칩n General -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-primary">{{ role_kpis.avg_overall|floatformat:1 }}</div>
                                    <div class="h6 mb-0">Calificaci칩n</div>
                                    <small class="text-muted">General</small>
                                </div>
                            </div>
                        </div>

                        <!-- Respuesta R치pida -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-success">{{ role_kpis.fast_response_rate }}</div>
                                    <div class="h6 mb-0">% Respuesta</div>
                                    <small class="text-muted">R치pida</small>
                                </div>
                            </div>
                        </div>

                        <!-- Rese침as Recientes -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-info h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-info">{{ role_kpis.last90_reviews_count }}</div>
                                    <div class="h6 mb-0">Rese침as</div>
                                    <small class="text-muted">Recientes</small>
                                </div>
                            </div>
                        </div>

                        <!-- Modalidad M치s Com칰n -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <div class="h4 mb-2 text-warning">{{ role_kpis.top_modality|default:'-'|title }}</div>
                                    <div class="h6 mb-0">Trabajo</div>
                                    <small class="text-muted">M치s com칰n</small>
                                </div>
                            </div>
                        </div>

                        <!-- Nivel de Dificultad -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-danger h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-danger">
                                        {% for item in role_kpis.difficulty_distribution %}
                                            {% if item.difficulty_rating == 'easy' %}{{ item.count }}{% endif %}
                                        {% empty %}0{% endfor %}
                                    </div>
                                    <div class="h6 mb-0">Proceso</div>
                                    <small class="text-muted">F치cil</small>
                                </div>
                            </div>
                        </div>

                        <!-- Comunicaci칩n Excelente -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-secondary h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-secondary">
                                        {% for item in role_kpis.communication_distribution %}
                                            {% if item.communication_rating == 'excellent' %}{{ item.count }}{% endif %}
                                        {% empty %}0{% endfor %}
                                    </div>
                                    <div class="h6 mb-0">Comunicaci칩n</div>
                                    <small class="text-muted">Excelente</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci칩n adicional -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>游눠 Informaci칩n 칰til:</strong>
                        Basado en {{ role_kpis.total_reviews }} rese침as de candidatos.
                        {% if role_kpis.top_modality_rating %}
                        El trabajo {{ role_kpis.top_modality|lower }} tiene {{ role_kpis.top_modality_rating }}/5 estrellas de promedio.
                        {% endif %}
                    </div>
    
                    {% elif user.profile.role == 'company_rep' %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-success mb-3">
                                <i class="fas fa-building me-2"></i>
                                Panel de Control de tu Empresa
                            </h5>
                            <p class="text-muted small">M칠tricas importantes para mejorar tu proceso de selecci칩n</p>
                        </div>
                    </div>

                    <!-- 6 tarjetas principales para empresas -->
                    <div class="row mb-4 g-3">
                        <!-- Puntuaci칩n General -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-primary">{{ role_kpis.avg_overall|floatformat:1 }}</div>
                                    <div class="h6 mb-0">Puntuaci칩n</div>
                                    <small class="text-muted">General</small>
                                </div>
                            </div>
                        </div>

                        <!-- Rese침as Aprobadas -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-success">{{ role_kpis.approval_rate }}</div>
                                    <div class="h6 mb-0">% Aprobadas</div>
                                    <small class="text-muted">rese침as</small>
                                </div>
                            </div>
                        </div>

                        <!-- Respuestas R치pidas -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-info h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-info">{{ role_kpis.compromiso_rate }}</div>
                                    <div class="h6 mb-0">% Respuestas</div>
                                    <small class="text-muted">R치pidas</small>
                                </div>
                            </div>
                        </div>

                        <!-- Total Rese침as -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-warning">{{ role_kpis.total_reviews }}</div>
                                    <div class="h6 mb-0">Total</div>
                                    <small class="text-muted">Rese침as</small>
                                </div>
                            </div>
                        </div>

                        <!-- Comunicaci칩n -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-secondary h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-secondary">{{ role_kpis.avg_communication|floatformat:1 }}</div>
                                    <div class="h6 mb-0">Comunicaci칩n</div>
                                    <small class="text-muted">promedio</small>
                                </div>
                            </div>
                        </div>

                        <!-- Dificultad -->
                        <div class="col-md-4 col-lg-2">
                            <div class="card border-danger h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-danger">{{ role_kpis.avg_difficulty|floatformat:1 }}</div>
                                    <div class="h6 mb-0">Dificultad</div>
                                    <small class="text-muted">del proceso</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado de rese침as -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-tasks me-2"></i>
                                Estado de las Rese침as Recibidas
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="card border-success text-center">
                                        <div class="card-body">
                                            <div class="display-6 mb-1 text-success">{{ role_kpis.approved_count }}</div>
                                            <div class="h6 mb-0">Aprobadas</div>
                                            <small class="text-muted">publicadas</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning text-center">
                                        <div class="card-body">
                                            <div class="display-6 mb-1 text-warning">{{ role_kpis.pending_count }}</div>
                                            <div class="h6 mb-0">Pendientes</div>
                                            <small class="text-muted">esperando revisi칩n</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-danger text-center">
                                        <div class="card-body">
                                            <div class="display-6 mb-1 text-danger">{{ role_kpis.rejected_count }}</div>
                                            <div class="h6 mb-0">Rechazadas</div>
                                            <small class="text-muted">no publicadas</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 츼reas de mejora -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-bullseye me-2"></i>
                                츼reas donde puedes mejorar
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <div class="h4 mb-1 text-primary">{{ role_kpis.avg_communication|floatformat:1 }}/5</div>
                                            <div class="h6 mb-0">Comunicaci칩n</div>
                                            <small class="text-muted">claridad en respuestas</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <div class="h4 mb-1 text-orange">{{ role_kpis.avg_difficulty|floatformat:1 }}/5</div>
                                            <div class="h6 mb-0">Complejidad</div>
                                            <small class="text-muted">del proceso</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <div class="h4 mb-1 text-info">{{ role_kpis.avg_response_time|floatformat:1 }}/5</div>
                                            <div class="h6 mb-0">Velocidad</div>
                                            <small class="text-muted">en dar feedback</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>游눠 Consejos:</strong>
                                {% if role_kpis.avg_communication < 4 %}
                                Mejora la comunicaci칩n para dar mejor impresi칩n a los candidatos.
                                {% elif role_kpis.avg_response_time < 4 %}
                                Los candidatos valoran respuestas r치pidas.
                                {% elif role_kpis.approval_rate < 80 %}
                                Revisa por qu칠 se rechazan tantas rese침as.
                                {% else %}
                                춰Excelente trabajo! Tus procesos est치n funcionando muy bien.
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Bot칩n para ver rese침as rechazadas -->
                    {% if role_kpis.rejected_count > 0 %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-center">
                                <a href="{% url 'rejected_reviews' company.id %}" class="btn btn-outline-danger btn-lg">
                                    <i class="fas fa-ban me-2"></i>Ver Rese침as Rechazadas ({{ role_kpis.rejected_count }})
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===== GR츼FICOS DE AN츼LISIS (SOLO PARA USUARIOS SIN RESE칌AS PENDIENTES) ===== -->
    {% if user_can_access and chart_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        An치lisis Visual de Datos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Distribuci칩n de Calificaciones</h6>
                                    {% if chart_data.ratings %}
                                    <canvas id="ratingsChart" width="400" height="200"></canvas>
                                    {% else %}
                                    <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Modalidad de Trabajo</h6>
                                    {% if chart_data.modality %}
                                    <canvas id="modalityChart" width="400" height="200"></canvas>
                                    {% else %}
                                    <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Fortalezas y Debilidades</h6>
                                    {% if chart_data.strengths_weaknesses %}
                                    <canvas id="strengthsChart" width="400" height="200"></canvas>
                                    {% else %}
                                    <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Rese침as por Mes (칔ltimos 4 meses)</h6>
                                    {% if chart_data.timeline %}
                                    <canvas id="timelineChart" width="400" height="200"></canvas>
                                    {% else %}
                                    <p class="text-muted small">No hay suficientes datos para mostrar el gr치fico</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contenido condicional seg칰n acceso -->
    {% if user_can_access %}
        <!-- Usuario puede acceder - mostrar rese침as -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="mb-3">
                    <h2 class="h3 text-primary">Rese침as de la Empresa</h2>
                </div>
                
                {% if user_can_create_review and user.profile.role == 'candidate' %}
                <div class="row mb-4">
                    <div class="col-12">
                        <a href="{% url 'create_review' %}?company={{ company.id }}" class="btn btn-lg w-100" style="background: var(--secondary-blue); color: white; border: 1px solid var(--secondary-blue);" onmouseover="this.style.background='var(--primary-blue)'" onmouseout="this.style.background='var(--secondary-blue)'">
                            <i class="fas fa-plus me-2"></i>Crear Rese침a
                        </a>
                    </div>
                </div>
                {% endif %}
                
                {% if approved_reviews %}
                    <div class="row">
                        {% for review in approved_reviews %}
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">{{ review.user_profile.user.get_full_name|default:review.user_profile.user.username }}</h6>
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Aprobada
                                    </span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <strong>Cargo:</strong> {{ review.job_title }}
                                    </p>
                                    <p class="card-text">
                                        <strong>Modalidad:</strong> {{ review.get_modality_display }}
                                    </p>
                                    {% if review.image %}
                                    <div class="mb-3">
                                        <strong>Imagen:</strong>
                                        <div>
                                            <img src="{{ review.image.url }}" alt="Imagen rese침a" class="img-fluid rounded" style="max-height: 160px; object-fit: cover;">
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        <strong class="text-success">Pros:</strong>
                                        <p class="mb-2">{{ review.pros }}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong class="text-danger">Contras:</strong>
                                        <p class="mb-2">{{ review.cons }}</p>
                                    </div>

                                    {% if review.interview_questions %}
                                    <div class="mb-3">
                                        <strong>Preguntas de la Entrevista:</strong>
                                        <p class="mb-2">{{ review.interview_questions }}</p>
                                    </div>
                                    {% endif %}

                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ review.submission_date|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                                <div class="card-footer">
                                    <span class="badge bg-primary">Calificaci칩n: {{ review.overall_rating }}/5</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No hay rese침as a칰n</h4>
                        <p class="text-muted">S칠 el primero en compartir tu experiencia con esta empresa.</p>
                        {% if user_can_create_review and user.profile.role == 'candidate' %}
                            <a href="{% url 'create_review' %}?company={{ company.id }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Crear Primera Rese침a
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <!-- Usuario no puede acceder - mostrar mensaje apropiado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="h5 mb-0">
                            {% if user_has_pending_review %}
                                <i class="fas fa-clock me-2"></i>Rese침a Pendiente
                            {% elif user_has_contributed %}
                                <i class="fas fa-clock me-2"></i>Rese침a en Revisi칩n
                            {% else %}
                                <i class="fas fa-handshake me-2"></i>Participaci칩n Requerida
                            {% endif %}
                        </h3>
                    </div>
                    <div class="card-body text-center py-5">
                        {% if user_has_pending_review %}
                            <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                            <h4 class="text-warning">Tienes rese침as pendientes</h4>
                            <p class="text-muted">Tienes rese침as pendientes que debes completar antes de poder ver el contenido de cualquier empresa.</p>
                            <div class="mt-4">
                                <a href="{% url 'my_reviews' %}" class="btn btn-info">
                                    <i class="fas fa-list me-2"></i>Ver Mis Rese침as
                                </a>
                            </div>
                        {% elif user_has_contributed %}
                            <i class="fas fa-hourglass-half fa-4x text-warning mb-3"></i>
                            <h4 class="text-warning">Tu rese침a est치 siendo revisada</h4>
                            <p class="text-muted">Una vez aprobada, podr치s acceder al contenido completo de esta empresa.</p>
                            <div class="mt-4">
                                <a href="{% url 'my_reviews' %}" class="btn btn-info me-2">
                                    <i class="fas fa-list me-2"></i>Ver Mis Rese침as
                                </a>
                                <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-home me-2"></i>Explorar Otras Empresas
                                </a>
                            </div>
                        {% else %}
                            <i class="fas fa-handshake fa-4x text-warning mb-3"></i>
                            <h4 class="text-warning">Para ver las rese침as de esta empresa, primero debes participar</h4>
                            <p class="text-muted">Comparte tu experiencia en un proceso de selecci칩n para desbloquear el contenido completo.</p>
                            <p class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                El staff te asignar치 una empresa cuando participes en un proceso de selecci칩n.
                            </p>
                            <a href="{% url 'dashboard' %}" class="btn btn-primary btn-lg">
                                <i class="fas fa-building me-2"></i>Explorar Otras Empresas
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Botones de navegaci칩n -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex gap-2">
                {% if user.profile.role == 'company_rep' %}
                    <a href="{% url 'company_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Panel de Empresa
                    </a>
                {% else %}
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ chart_data|json_script:"chart-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos de los gr치ficos
    const chartData = JSON.parse(document.getElementById('chart-data').textContent);
    
    // Debug: Mostrar informaci칩n de debug en consola
    if (chartData.debug_info) {
        console.log('=== DEBUG INFO DE GR츼FICAS ===');
        console.log('Total rese침as:', chartData.debug_info.total_reviews);
        console.log('Fecha 칰ltima rese침a:', chartData.debug_info.latest_review_date);
        console.log('Hora actual:', chartData.debug_info.current_time);
        console.log('Datos de calificaciones:', chartData.debug_info.ratings_data);
        console.log('Datos de modalidad:', chartData.debug_info.modality_data);
        console.log('Datos de estado:', chartData.debug_info.status_data);
        console.log('Datos de timeline:', chartData.debug_info.timeline_data);
        console.log('Datos de fortalezas:', chartData.debug_info.strengths_data);
        console.log('================================');
    }
    
    // Colores para los gr치ficos
    const colors = {
        primary: '#1E3A8A',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        info: '#3B82F6',
        secondary: '#6B7280'
    };
    
    // Gr치fico de distribuci칩n de calificaciones
    if (chartData.ratings && Object.keys(chartData.ratings).length > 0) {
        const ratingsCtx = document.getElementById('ratingsChart');
        if (ratingsCtx) {
            new Chart(ratingsCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(chartData.ratings),
                    datasets: [{
                        label: 'N칰mero de Rese침as',
                        data: Object.values(chartData.ratings),
                        backgroundColor: [colors.warning, colors.warning, colors.warning, colors.warning, colors.warning],
                        borderColor: [colors.warning, colors.warning, colors.warning, colors.warning, colors.warning],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }
    
    // Gr치fico de modalidad de trabajo
    if (chartData.modality && Object.keys(chartData.modality).length > 0) {
        const modalityCtx = document.getElementById('modalityChart');
        if (modalityCtx) {
            new Chart(modalityCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(chartData.modality),
                    datasets: [{
                        data: Object.values(chartData.modality),
                        backgroundColor: [colors.primary, colors.success, colors.info],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
    }
    
    // Gr치fico de fortalezas y debilidades (Radar Chart)
    if (chartData.strengths_weaknesses && Object.keys(chartData.strengths_weaknesses).length > 0) {
        const strengthsCtx = document.getElementById('strengthsChart');
        if (strengthsCtx) {
            new Chart(strengthsCtx, {
                type: 'radar',
                data: {
                    labels: Object.keys(chartData.strengths_weaknesses),
                    datasets: [{
                        label: 'Calificaci칩n Promedio',
                        data: Object.values(chartData.strengths_weaknesses),
                        backgroundColor: 'rgba(30, 58, 138, 0.2)',
                        borderColor: colors.primary,
                        borderWidth: 2,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: colors.primaryDark,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }
    
    // Gr치fico de timeline de rese침as
    if (chartData.timeline && Object.keys(chartData.timeline).length > 0) {
        const timelineCtx = document.getElementById('timelineChart');
        if (timelineCtx) {
            new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(chartData.timeline),
                    datasets: [{
                        label: 'Cantidad de Rese침as',
                        data: Object.values(chartData.timeline),
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: colors.primary,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }
});
</script>

<!-- Datos estructurados adicionales para AEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ company.name }} - Rese침as y Opiniones",
  "description": "Lee rese침as y opiniones sobre {{ company.name }} en {{ company.location }}",
  "url": "{{ request.build_absolute_uri }}",
  "mainEntity": {
    "@type": "Organization",
    "name": "{{ company.name }}",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "{{ company.location }}",
      {% if company.region %}"addressRegion": "{{ company.region }}",{% endif %}
      "addressCountry": "{{ company.country }}"
    }
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "{{ request.scheme }}://{{ request.get_host }}/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Empresas",
        "item": "{{ request.scheme }}://{{ request.get_host }}/dashboard/"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": "{{ company.name }}",
        "item": "{{ request.build_absolute_uri }}"
      }
    ]
  }
}
</script>

{% endblock %}